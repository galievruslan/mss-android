package com.mss.infrastructure.ormlite;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;

import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.dao.GenericRawResults;
import com.j256.ormlite.dao.RawRowMapper;
import com.j256.ormlite.stmt.QueryBuilder;
import com.mss.domain.models.Constants;
import com.mss.domain.models.ProductUnitOfMeasure;
import com.mss.domain.models.Route;
import com.mss.domain.models.RoutePoint;

public class OrmliteRouteRepository extends OrmliteGenericRepository<Route> {
	
	public OrmliteRouteRepository(DatabaseHelper databaseHelper) throws Throwable{
		super(databaseHelper.getRouteDao());
	}
	
	public Iterable<Route> findByDate(Date date) throws Throwable {
		
		QueryBuilder<Route, Integer> queryBuilder = dao.queryBuilder();
		
		queryBuilder.where().eq(com.mss.domain.models.Constants.Tables.Route.DATE_FIELD , date);
		return dao.query(queryBuilder.prepare());
	}
	
	public Iterable<Route> findNotSynchronized(Date date) throws Throwable {
		String rawQuery = "select " + 
				Constants.Tables.Route.TABLE_NAME + "." + Constants.Tables.Entity.ID_FIELD  + " as [id], " +
				Constants.Tables.Route.TABLE_NAME + "." + Constants.Tables.Route.DATE_FIELD + " as [date] " +				
				"from " + Constants.Tables.Route.TABLE_NAME + " as " + Constants.Tables.Route.TABLE_NAME + " " +
				"inner join " + Constants.Tables.RoutePoint.TABLE_NAME + " as " + Constants.Tables.RoutePoint.TABLE_NAME + " on " +
				Constants.Tables.RoutePoint.TABLE_NAME + "." + Constants.Tables.RoutePoint.ROUTE_FIELD + " = " +
				Constants.Tables.Route.TABLE_NAME + "." + Constants.Tables.Entity.ID_FIELD + " AND " +
				Constants.Tables.RoutePoint.TABLE_NAME + "." + Constants.Tables.RoutePoint.SYNCHRONIZED_FIELD + " = 0";
		
		DateFormat simpleDateFormat = SimpleDateFormat.getInstance();
		GenericRawResults<Route> rawResults =
				dao.queryRaw(rawQuery,
				    new RawRowMapper<Route>() {
				            public Route mapRow(String[] columnNames,
				              String[] resultColumns) {
				            	return new Route(Long.parseLong(resultColumns[0]),
				            			simpleDateFormat.parse(resultColumns[1]));
				        }
				    });
		
		ProductUnitOfMeasure productUnitOfMeasure = rawResults.getFirstResult();
		rawResults.close();
		return productUnitOfMeasure;
	}
}
